<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day Notes Frontend Simulation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Day Notes Frontend Simulation Test</h1>
    <p>This test simulates the exact behavior of the DayNotesEditor component to debug persistence issues.</p>

    <div class="test-section info">
        <h3>Test Configuration</h3>
        <label>
            Test Date: 
            <input type="date" id="testDate" value="2024-11-04">
        </label>
        <br><br>
        <label>
            Server URL: 
            <input type="text" id="serverUrl" value="http://localhost:3001" style="width: 200px;">
        </label>
    </div>

    <div class="test-section">
        <h3>Step 1: Load Day Notes</h3>
        <button onclick="loadDayNotes()">Load Day Notes</button>
        <div id="loadResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Edit Notes</h3>
        <textarea id="notesContent" placeholder="Edit your notes here..."></textarea>
        <button onclick="saveDayNotes()">Save Day Notes</button>
        <div id="saveResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Simulate Navigation (Load Different Date)</h3>
        <button onclick="simulateNavigation()">Navigate to Different Date</button>
        <div id="navigationResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Return to Original Date</h3>
        <button onclick="returnToOriginalDate()">Return to Original Date</button>
        <div id="returnResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 5: Simulate Page Reload</h3>
        <button onclick="simulateReload()">Simulate Reload (Clear Cache & Load)</button>
        <div id="reloadResult" class="log"></div>
    </div>

    <script>
        // Simulate the calendar service behavior
        class CalendarServiceSimulation {
            constructor() {
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000; // 5 minutes
            }

            clearCache() {
                this.cache.clear();
                this.log('ðŸ§¹ Cache cleared');
            }

            async getCachedData(key, fetchFn, ttl = this.cacheTimeout) {
                const cached = this.cache.get(key);
                
                if (cached && Date.now() - cached.timestamp < ttl) {
                    this.log(`ðŸ“¦ Using cached data for key: ${key}`);
                    return cached.data;
                }

                this.log(`ðŸŒ Fetching fresh data for key: ${key}`);
                const data = await fetchFn();
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });

                return data;
            }

            formatDateToISO(date) {
                return date.toISOString().split('T')[0];
            }

            async getDayNotes(date) {
                const dateStr = this.formatDateToISO(date);
                const cacheKey = `day-notes-${dateStr}`;
                
                return this.getCachedData(cacheKey, async () => {
                    try {
                        const serverUrl = document.getElementById('serverUrl').value;
                        const response = await fetch(`${serverUrl}/api/calendar/day-notes/${dateStr}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        this.log(`âœ… Loaded day notes for ${dateStr}: ${result.notes ? 'Has content' : 'Empty'}`);
                        return result.notes || '';
                    } catch (error) {
                        this.log(`âŒ Error loading day notes for ${dateStr}: ${error.message}`);
                        return '';
                    }
                });
            }

            async saveDayNotes(date, notes) {
                const dateStr = this.formatDateToISO(date);
                
                try {
                    const serverUrl = document.getElementById('serverUrl').value;
                    const response = await fetch(`${serverUrl}/api/calendar/day-notes/${dateStr}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ notes })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    this.log(`âœ… Saved day notes for ${dateStr}: ${result.success ? 'Success' : 'Failed'}`);

                    // Invalidate cache for this day
                    this.cache.delete(`day-details-${dateStr}`);
                    this.cache.delete(`day-notes-${dateStr}`);
                    this.log(`ðŸ—‘ï¸ Invalidated cache for ${dateStr}`);
                    
                    return result;
                } catch (error) {
                    this.log(`âŒ Error saving day notes for ${dateStr}: ${error.message}`);
                    throw error;
                }
            }

            log(message) {
                console.log(message);
                // Also log to the current active result div
                const activeDiv = document.querySelector('.log:last-child');
                if (activeDiv) {
                    activeDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
                }
            }
        }

        const calendarService = new CalendarServiceSimulation();
        let currentDate = new Date('2024-11-04');

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        async function loadDayNotes() {
            clearLog('loadResult');
            
            try {
                const testDate = document.getElementById('testDate').value;
                currentDate = new Date(testDate + 'T00:00:00');
                
                calendarService.log(`ðŸ”„ Loading day notes for ${testDate}...`);
                const notes = await calendarService.getDayNotes(currentDate);
                
                document.getElementById('notesContent').value = notes;
                calendarService.log(`ðŸ“ Loaded notes content (${notes.length} characters)`);
                
                if (notes) {
                    try {
                        const parsed = JSON.parse(notes);
                        calendarService.log(`âœ… Notes are valid JSON: ${parsed.type || 'unknown type'}`);
                    } catch (e) {
                        calendarService.log(`âš ï¸ Notes are not JSON: ${notes.substring(0, 50)}...`);
                    }
                }
                
            } catch (error) {
                calendarService.log(`âŒ Error loading day notes: ${error.message}`);
            }
        }

        async function saveDayNotes() {
            clearLog('saveResult');
            
            try {
                const notes = document.getElementById('notesContent').value;
                
                if (!notes.trim()) {
                    calendarService.log('âš ï¸ No notes to save');
                    return;
                }
                
                // Create a proper Novel JSON structure if it's plain text
                let notesToSave = notes;
                if (!notes.startsWith('{')) {
                    notesToSave = JSON.stringify({
                        type: 'doc',
                        content: [
                            {
                                type: 'paragraph',
                                content: [
                                    { type: 'text', text: notes }
                                ]
                            }
                        ]
                    });
                    calendarService.log('ðŸ“ Converted plain text to Novel JSON format');
                }
                
                calendarService.log(`ðŸ’¾ Saving day notes (${notesToSave.length} characters)...`);
                await calendarService.saveDayNotes(currentDate, notesToSave);
                calendarService.log('âœ… Save completed');
                
            } catch (error) {
                calendarService.log(`âŒ Error saving day notes: ${error.message}`);
            }
        }

        async function simulateNavigation() {
            clearLog('navigationResult');
            
            try {
                // Navigate to a different date
                const differentDate = new Date('2024-11-05');
                calendarService.log(`ðŸ”„ Navigating to different date: ${calendarService.formatDateToISO(differentDate)}`);
                
                const notes = await calendarService.getDayNotes(differentDate);
                calendarService.log(`ðŸ“ Loaded notes for different date (${notes.length} characters)`);
                
                currentDate = differentDate;
                document.getElementById('notesContent').value = notes;
                
            } catch (error) {
                calendarService.log(`âŒ Error during navigation: ${error.message}`);
            }
        }

        async function returnToOriginalDate() {
            clearLog('returnResult');
            
            try {
                const originalDate = new Date(document.getElementById('testDate').value + 'T00:00:00');
                calendarService.log(`ðŸ”„ Returning to original date: ${calendarService.formatDateToISO(originalDate)}`);
                
                const notes = await calendarService.getDayNotes(originalDate);
                calendarService.log(`ðŸ“ Loaded notes for original date (${notes.length} characters)`);
                
                currentDate = originalDate;
                document.getElementById('notesContent').value = notes;
                
                if (notes) {
                    calendarService.log('âœ… Notes were preserved!');
                } else {
                    calendarService.log('âŒ Notes were lost!');
                }
                
            } catch (error) {
                calendarService.log(`âŒ Error returning to original date: ${error.message}`);
            }
        }

        async function simulateReload() {
            clearLog('reloadResult');
            
            try {
                calendarService.log('ðŸ”„ Simulating page reload...');
                
                // Clear all cache (simulating page reload)
                calendarService.clearCache();
                
                // Load the current date again
                const notes = await calendarService.getDayNotes(currentDate);
                calendarService.log(`ðŸ“ Loaded notes after "reload" (${notes.length} characters)`);
                
                document.getElementById('notesContent').value = notes;
                
                if (notes) {
                    calendarService.log('âœ… Notes survived reload!');
                } else {
                    calendarService.log('âŒ Notes disappeared after reload!');
                }
                
            } catch (error) {
                calendarService.log(`âŒ Error during reload simulation: ${error.message}`);
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('Day Notes Frontend Simulation Test loaded');
        });
    </script>
</body>
</html>